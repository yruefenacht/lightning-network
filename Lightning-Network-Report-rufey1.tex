\documentclass[a4paper, 12pt]{report}

% Charset
\usepackage[utf8]{inputenc}
% Language
\usepackage[british]{babel}
% Font
\usepackage[default]{sourcesanspro}
\usepackage[T1]{fontenc}
\usepackage{titlesec, color}
\definecolor{gray75}{gray}{0.75}
\newcommand{\hsp}{\hspace{20pt}}
\usepackage{microtype}
\usepackage{float}
\usepackage{tabto}
% Color
\usepackage{xcolor}
% Graphics
\usepackage{graphicx}
\usepackage{fancyhdr}
\graphicspath{ {./img/} }
% Indexing
\usepackage{index}
\makeindex
% Hyperlinks
\usepackage{hyperref}
\hypersetup{
 	colorlinks=true, 
	linkcolor=black,
	urlcolor=blue,
}

\begin{document}

% Title page
\title{\Large{\textbf{The Bitcoin Lightning Network}}}
\author{Yannick Mawuena Rüfenacht \\ \href{mailto:yannick.ruefenacht@hotmail.com}{yannick.ruefenacht@hotmail.com}}
\date{October 21, 2020\\Version 1.0.0}
\maketitle

% Quote
\begin{quote}
\vspace*{\fill}
\textit{``Lightning is a decentralized network using smart contract functionality in the blockchain to enable instant payments across a network of participants."}
\par\raggedleft--- \textup{Joseph Poon}
\vspace*{\fill}
\end{quote}

% Abstract
\begin{abstract}
Today’s Bitcoin protocol provides the possibility to participate in a secure decentralized payment system without a single custodial third-party holding funds. This system uses the blockchain technology to distribute all performed transactions across the network of participants for them to reach general consensus. The process of securing and distributing transactions takes up a substantial amount of time, which creates a significant drag on the ability to encompass all global financial transactions. The idea of the lightning network is to create micropayment channels between participants that operate off-blockchain. These channels can be used to instantly exchange Bitcoins without distributing them to the blockchain. Upon closing a micropayment channel, the final balance of that channel is broadcasted to the main blockchain. This concept could prove to be useful especially in situations where two participants frequently exchange money.
\end{abstract}

% Table of Contents
\tableofcontents
\listoffigures

% Formatting
\setlength{\parskip}{1em}
\setlength{\parindent}{0em}
\titleformat{\chapter}[hang]{\LARGE\bfseries}{\thechapter\hsp\textcolor{gray75}{|}\hsp}{0pt}{\LARGE\bfseries}
\titleformat{\section}[hang]{\large\bfseries}{\thesection\hsp\textcolor{gray75}{|}\hsp}{0pt}{\large\bfseries}

% Page bottom transition
%\widowpenalties 1 10000
%\raggedbottom

\chapter{Introduction}
\par The primary aim of this paper is to provide a simple to understand explanation of the Lightning Network and why it is necessary. Furthermore, this paper also dives into the underlying system upon which the Lightning Network operates, namely the Bitcoin blockchain system. The Lightning Network uses the blockchain and Bitcoin smart contracts to create a secure network of participants which are able to perform transactions at high volume and speed. To be able to understand how the lightning network works or why it is even necessary, requires a basic understanding of the blockchain and Bitcoin.
\par This paper guides the reader through a list of steps that show how the lightning network is built, starting from the basics of a blockchain. Each step builds on top of the previous one. It is therefore recommended to read this paper in the right order.

\chapter{A Brief Overview of the Bitcoin Blockchain}
\par The way of ordinary banking systems usually goes as follows: The customer deposits his money on a bank account and when a payment is done, the bank either adds or subtracts the amount from his or her account. Or sometimes the customer withdraws some money from the ATM. The underlying concern hereby is that in each of those use cases there is always one centralized system involved which is in power of handling all the transactions. The inner workings of that system are strictly sealed to the outside, which has the capability to create trust issues. And this is where the idea of Bitcoin comes to the surface.

\section{The Idea of Bitcoin}
\par The main idea of Bitcoin is to remove the aspect of centralized control and to form a network of users where everyone is connected to everyone and the same rights apply to everyone.  

\begin{figure}[H]
	\includegraphics[width=\textwidth]{01_Decentralized}
	\caption{Conventional Banking System vs Decentralized System}
	\label{fig:01_Decentralized}
\end{figure}

\par To achieve this, the history of all transactions is stored in a public ledger, which is accessible to everyone. But instead of storing this ledger in one central place, every participant obtains their own copy so that the ledger is distributed to everyone throughout the network of participants. Anyone who then performs a transaction broadcasts it out to the entire world for everyone to hear and to include it in their private ledgers. 
\par At first, the degree of openness that this system provides might seem absurd. But the fact that all the records of the transactions are publicly available also means that everyone can verify the validity of every transaction. And this is where Bitcoin gains its immense trust and security benefits.

\section{The Issue of Decentralization}
\par Although the approach of a centralized network seems quite appealing so far, there is an important issue that arises very quickly. While the idea of everyone broadcasting their transactions to the entire network would work for a small number of people, it would become significantly more difficult to ensure that every member of the network receives every transaction in the same order, as the number of participants increases. Network delays could cause transactions to arrive in different orders in different places. This raises the question: How can the ledger maintain the right order of transactions across the entire network of participants. 
\par This is precisely the problem that was addressed in the original Bitcoin paper. The solution that Bitcoin offers lies within the functionality of its blockchain.

\section{The Bitcoin Blockchain}
\par In order to maintain the right order of all transactions, the broadcasting of new transactions needs to be regulated and a new mechanism that locks the order off all the transactions needs to be implemented.
\paragraph{Blocks} \hspace{0pt} \\
First of all, the ledger is split into a group of blocks. Each block contains a set of transactions and a special value at the bottom that is referred to as the “proof of work”. 

\begin{figure}[h]
	\includegraphics[width=\textwidth]{02_Ledger_Blocks}
	\caption{Ledger being split into blocks}
	\medskip
	\small Instead of distributing one file that contains the history of transactions, it is much more efficient to distribute the list as packages accross the Bitcoin network.
	\label{fig:02_Ledger_Blocks}
\end{figure}

\paragraph{Proof of work} \hspace{0pt} \\
The proof of work, also known as the hash of the block, is a special numeric value that is required for each block. A block without a proof of work is considered invalid. The value is special in the sense that it needs to be calculated. The calculation takes on average 10 minutes of computational work. This process is usually performed by special members of the network called “Minors”. The purpose of this mechanism is to regulate the number of transactions that are being broadcasted and to make it difficult for attackers to generate new blocks. Furthermore, the proof of work is unique for each block, this means that it could also act as a unique identifier.
\paragraph{Ordering transactions} \hspace{0pt} \\
To maintain a fixed order to these blocks, each block additionally contains the proof of work of its previous block.\footnote{The first block is a special case since it cannot point to a previous block. It is named the Genisis Block} This causes each block to have a reference to its previous block which ultimately results in a fixed list.

\begin{figure}[h]
	\includegraphics[width=\textwidth]{03_Linked_Blocks}
	\caption{Chaining of the blocks}
	\small Each block has the proof of work of its previous block and also uses it to generate its own proof of work.
	\medskip
	\label{fig:03_Linked_Blocks}
\end{figure}

\paragraph{Security} \hspace{0pt} \\
The proof of work, or hash, is unique for each block as aforementioned. It is calculated using the contents of the block i.e., the set of transactions and the hash of the previous block. If the content gets changed, the hash automatically gets changed as well. The fact that each block contains the hash of the previous block is precisely what makes the blockchain so secure. 
\par If for example the content of the second block from the picture above gets tampered, it would automatically change its hash. This in turn would make the third block invalid since it no longer stores a valid hash of its previous block. Altering the third block causes the fourth block to be invalid. This scenario repeats itself throughout the entire list. This means that changing one block would consequently require changing the entire chain of blocks for it to be valid again. 
\par Since the ledger now basically consists of a group of blocks that are immutably chained together, it is commonly referred to as the “blockchain”. 

\section{The Ledger is the Currency}
\par Bitcoin is said to be a cryptocurrency. This poses the question: What actually is a cryptocurrency? The answer is quite simple: \textit{It is a ledger. The history of transactions is the currency.}
\par That being said, it is theoretically possible to remove the need for cash. Hypothetically, if everyone in the world used this ledger, it would be possible to send and receive money on this ledger for all eternity without ever converting it to cash.

\chapter{The Scalability Problem with Bitcoin}
\par As far as safety is concerned, Bitcoin provides an excellent solution with its use of a distributed ledger. The Bitcoin blockchain requires, that all state modifications of the ledger must be broadcasted to each node of the Bitcoin network. It is through this mechanism that a general consensus of everyone’s balances can be achieved. However, as a payment platform, Bitcoin by itself cannot handle the whole transactions of the world anytime in the near future. The fact that all transactions must be broadcasted throughout the entire world, creates significant time delays which result in Bitcoin being only able to handle a few transactions per second.

\section{Blockchain Fees}
\par Whenever new transactions on a blockchain are created, miners need to group those transactions into blocks and secure those blocks by finding a valid hash. This process is quite computationally intensive. To compensate the miners for the work that they provide to secure the network, blockchain users need to pay a fee for creating a transaction. Every time a miner successfully stores a block of transactions on the blockchain, they are rewarded with the transaction fees that are contained in the block. 
\par Blocks with higher amounts of transaction fees naturally have more priority, which leads to higher amounts of transaction fees for transactions that need to be resolved quicker. Big transactions fees make it difficult to attract a large user base.

\chapter{Introducing the Lightning Network}
\par The Lightning network presents an additional layer that operates on top of the Bitcoin blockchain with the aim to enable instant and feeless micropayments. It has been introduced in 2015 and has been in development ever since. The main idea of the Lightning Network is to establish separate end-to-end connections between participants in order to not store every small transaction on the main blockchain, but rather off-blockchain. These connections are named micropayment channels or simply payment channels.

\section{Payment channels}
\par If two participants regularly exchange amounts, they would open a new payment channel between them, that is off-blockchain. This allows them to perform quick payments between each other. Once they conclude their business, they conduct a closing transaction on the main blockchain which contains the final balances of their wallets on the payment channel. That way, even if thousands of transactions are performed on the payment channel, only two transactions will be stored on the blockchain eventually. One for opening and one for closing the payment channel.

\paragraph{Creating a new payment channel} \hspace{0pt} \\
During the initiation of the payment channel, both parties provide a certain balance of Bitcoin onto their ends of the payment channel, allowing that balance to go back and forth between them whenever transactions are made. To complete the creation of the new payment channel, the inputs of both parties are put into a transaction that gets signed by both parties, and eventually, broadcasted on the main blockchain. This transaction is called the funding transaction.

\paragraph{Commitment transactions} \hspace{0pt} \\
Once the funding transaction has been added to the blockchain and settled, both parties can spend their balances on the channel in a series of commitment transactions that reallocate their balances accordingly. These kinds of transactions can remain between the channel participants and do not need to be stored on the blockchain.

\paragraph{Closing the payment channel} \hspace{0pt} \\
The balances of both parties can remain off-blockchain and be updated continuously until finally a settlement transaction is performed. This transaction contains the final balances of both parties and gets added to the main blockchain.

\paragraph{Examples} \hspace{0pt} \\
In the example money flows both ways in the payment channel, therefore it is considered a bi-directional payment channel.

\begin{figure}[H]
	\centering
	\includegraphics[width=13cm]{04_Bidirectional_Channel}
	\caption{Bi-directional payment channel}
	\medskip
	\small In a bi-directional payment channel both parties have their own balance which they can use to exchange coins. Since money flows in both directions, it is considered a bi-directional payment channel.
	\label{fig:04_Bidirectional_Channel}
\end{figure}

\par Naturally, there can also be payment channels where money only flows in one direction, from one party to another. The example below demonstrates how a payment channel could be used to perform micropayments to an internet service provider in exchange for mobile data.

\begin{figure}[H]
	\centering
	\includegraphics[width=10cm]{05_Onedirectional_Channel}
	\caption{Example of a payment channel to pay for mobile data usage}
	\medskip
	\small This example shows how payment channel could be used to pay miniscule amounts of Bitcoin in exchange for small chunks of data.
	\label{fig:05_Onedirectional_Channel}
\end{figure}

\paragraph{Security} \hspace{0pt} \\
Payment channels rely on Bitcoin security primitives which prevent participants from stealing Bitcoin or losing Bitcoin due to uncooperative behaviour from the opposite party. Such security primitives include Multi-Signatures, Timelocks and No-Double-Spends.

\section{Multi-Signatures}
\par As the name suggests, the idea behind Multisig technology is to have multiple keys be in control of a Bitcoin balance. Multi-Signatures are described as K of N signature schemes, meaning that there are N valid predefined signatories that are authorized to release funds from a particular Bitcoin balance. Of those N keys, K is the number of signatures that are required to sign a transaction.

\paragraph{2 of 2 Multi-Signature} \hspace{0pt} \\
In the case of the Lightning Network, a 2 of 2 Multi-Signature type is used. This requires both parties of the channel to sign any transaction, because of that, one party alone cannot sign and execute a transaction on their own.

\section{Timelocks}
\par A payment channel gets closed when either party decides to publish the latest transaction onto the blockchain. That said, there is one major security concern about this idea. If for example Bob and Alice are using a payment channel in which, according to the latest commitment transaction, Alice has a greater Balance than Bob, the Question arises: Can Bob not simply broadcast a prior state in which he had a more advantageous balance and thus cheat?

\par The way this can be solved is to set a timelock. A timelock is an embedded delay or countdown in a commitment transaction that determines when the transaction becomes valid. Later commitment transactions have a shorter timelock and will therefore become valid sooner. This prevents either party from spending an older commitment transaction.

\begin{figure}[h]
	\centering
	\includegraphics[width=13cm]{06_Timelocks}
	\caption{Timelocks}
	\medskip
	\small Transaction number 400 has the smallest timelock and thus becomes valid sooner than every other transaction.
	\label{fig:06_Timelocks}
\end{figure}

\section{No Double-Spend}
\par Once a commitment transaction has been broadcasted and its timelock has finished, it becomes a legitimate transaction and all the other commitment transactions automatically become invalid, since there can only be one final settlement transaction per payment channel. This principle is called No Double-Spend.  As seen in figure \ref{fig:06_Timelocks}, transaction number 400 is the first one to become valid and once it does, the other 399 transactions become invalid, which makes it impossible for Bob to cheat and spend the first transaction, where he had 36 mBTC instead of 30mBTC.

\section{Routing}
\par Another way to look at payment channels is to picture them as strings of beads stretched between two people. If Alice has to pay Bob, she can simply push one of her beads to his side. If Bob also has a payment channel with Charlie, Alice can pay Charlie through Bob, meaning that she pushes one of her beads to Bob first, and then Bob pushes a bead over to Charlie.

\begin{figure}[H]
	\centering
	\includegraphics[width=12cm]{07_Beads}
	\caption{Routed payment}
	\medskip
	\small Alice can pay Charlie through Bob by paying Bob first and then letting Bob pay Charlie
	\label{fig:07_Beads}
\end{figure}

\par The idea of people being able to forward payments from one person to another, is called routed payments. If the network of the participants is sufficiently enough connected, everyone will be reachable within a certain number of hops from one end to another. That is precisely what the Lightning Network is all about.

\section{Hash and Timelock Contracts}
\par The concept of routed payments is an essential part of the Lightning Network. Therefore, it is all the more important that it provides appropriate security mechanisms to prevent coin theft.
\par Payment channels use what is known as “locks” to secure transactions. Locks can be placed around beads to constrain their movement. The Lightning Network uses two types of locks: the hash and time lock. The hash lock is a type of lock that only opens when provided with the correct password. The time lock on the other hand opens automatically after a time delay.

\begin{figure}[H]
	\centering
	\includegraphics[width=9cm]{08_Locks}
	\caption{Hash and Time lock}
	\medskip
	\small The hash lock opens when presented with a password that hashes to the specified hash (420f8 in this case). The time lock opens after the specified time has elapsed (48 hours in this case).
	\label{fig:08_Locks}
\end{figure}

\par If a routed payment is performed, for example if Alice wants to pay Charlie through Bob, all members need to participate in an elaborate series of steps.

\paragraph{Step 1} \hspace{0pt} \\
First, Charlie thinks up a secret password and tells Alice the password’s hash. In this example the password is “Balderdash”, and its hash is “420f8”. In the next step, Alice uses that hash to send a password protected bead over to Bob. She does this by placing a hash lock around the bead for Bob that opens only when presented with a password that hashes to “420f8”. In addition to that, she also places a time lock around the bead that opens automatically after 48 hours and returns the bead to Alice if Bob does not participate in this transaction procedure.

\begin{figure}[H]
	\includegraphics[width=\textwidth]{09_HTLC_Step1}
	\caption{Alice sends bead with hash lock to Bob}
	\medskip
	\small Alice thinks up a password and sends Alice the password’s hash. Next, Alice sends a bead over to Bob that is protected with a hash and time lock. Bob can only receive this bead if he knows the password. If Bob does not receive the bead within 48 hours, it is returned to Alice
	\label{fig:09_HTLC_Step1}
\end{figure}

\paragraph{Step 2} \hspace{0pt} \\
Bob now knows that he receives the bead if he can figure out the password within 48 hours. He also knows that Charlie will reveal the password to him in exchange for one of his beads. Therefore, Bob places the same hash lock and another time lock around his bead and pushes it over to Charlie. In order for Charlie to open the hash lock, he needs to enter the password in plain in plain sight, which is the same password Bob needs to open the hash lock from Alice.

\begin{figure}[H]
	\includegraphics[width=\textwidth]{10_HTLC_Step2}
	\caption{Bob sends bead with copy of Alice's hash lock to Charlie}
	\medskip
	\small Bob knows that the bead from Alice will be his, if Charlie reveals the password of Alice's hash lock within the 48 hours time frame. He places the same hash lock around one of his beads, adds a time lock, and pushes it to Charlie. The only way Charlie can take the bead is to reveal her password that Bob needs to claim the bead from Alice.
	\label{fig:10_HTLC_Step2}
\end{figure} 

\paragraph{Step 3} \hspace{0pt} \\
Charlie then enters “Balderdash” into the hash lock and receives the bead from Bob. The lock’s CPU confirms that hash(“Balderdash”) = 420f8, and then opens.

\begin{figure}[H]
	\includegraphics[width=\textwidth]{11_HTLC_Step3}
	\caption{Charlie reveals password and takes his bead}
	\medskip
	\small Charlie enters his password into Bob's hash lock to open it and take the bead. This reveals the password to Bob.
	\label{fig:11_HTLC_Step3}
\end{figure} 

\paragraph{Step 4} \hspace{0pt} \\
With knowledge of Charlie’s password, Bob unlocks the hash lock from Alice in the same way and receives his bead. With that, the routed payment is complete.

\begin{figure}[H]
	\includegraphics[width=\textwidth]{12_HTLC_Step4}
	\caption{Bob receives his bead from Alice with Charlie's password}
	\medskip
	\small With knowledge of Charlie's password, Bob can now open the hash lock from Alice and take his bead. This completes the payment.
	\label{fig:12_HTLC_Step4}
\end{figure} 

\paragraph{Routed transaction fees} \hspace{0pt} \\
When looking at this example, in particular on the role of Bob, one might wonder why Bob would even bother to participate in this whole ritual in the first place if there is nothing in it for him. In practice however, Alice would add a small additional amount of Bitcoin to her payment for Bob, as a means of motivating Bob to complete the payment and compensating his effort. When the payment is complete, Bob would have slightly more Bitcoin than he started with. The concept of Lightning Network fees will be discussed in more detail in chapter~\ref{sec:Lightning_Network_Fees}.

\paragraph{Uncooperative behaviour} \hspace{0pt} \\
Should a transaction fail, for any reason, as well as uncooperative behaviour, the time lock will enable the affected participants to retrieve their funds. For example, if Bob becomes uncooperative after Alice shifts her bead over, the time lock is what allows Alice to get her funds back. She just needs to wait for the time lock to expire. Since Bob needs the password from Charlie to receive Alice’s payment, which he can only attain by sending one of his beads to Charlie, there is no possibility for Bob to steal Alice’s bead.

\section{Lightning Network Fees} \label{sec:Lightning_Network_Fees}
\par For a participant to route their payments to their destination, they need to have capital available on the routes that are visible. If there is not enough liquidity available on the routes, then it becomes impossible to route payments.
\par The Lightning Network is setup in a way that rewards participants who provide liquidity to the network. If a participant routes payments, they can set fees that other participants will have to pay to use their capital for routing.\newline
There are two types of fees: The \textit{base fee} and the \textit{liquidity provider fee}. 

\paragraph{Base Fee} \hspace{0pt} \\
The base fee is a flat rate that a participant charges per transaction that is routed through their node in the network. This fee is set by every participant based on what they think their capital is worth. Someone for instance might set their base fee to 0.1 mBTC while someone else, who perhaps is not as liquid, might set their base fee to 0.3 mBTC.

\paragraph{Liquidity Provider Fee} \hspace{0pt} \\
This fee is charged based on how much Bitcoin is routed though one’s payment channel. An example would be a fee of 0.01 mBTC for every mBTC that is routed through one’s payment channel.

\paragraph{Example} \hspace{0pt} \\
Assuming Charlie needs to pay Alice 5 mBTC through Bob, and Bob has the following Lightning Network Fees: 

\begin{itemize}
	\item[--] Base Fee: \tab \textit{0.1 mBTC} 
	\item[--] Liquidity Provider Fee: \tab \textit{1\% of payment amount} 
\end{itemize}

The fee for Charlie’s lightning payment would result to a total of:\\
0.1 + (5 * 0.01) = \textbf{0.15 mBTC}

\paragraph{Comparison to traditional Bitcoin blockchain} \hspace{0pt} \\
A traditional node in the Bitcoin blockchain does not generate any money for its owner. All fees collected go directly to the miners. On the Lightning Network however, there are no miners, and all the fees go to the node owners. This key difference also aims to encourage decentralization.

\chapter{Protential Risks of the Lightning Network}
\section{Coin Theft via Tracking}

\chapter{Use Cases}
\section{Instant Payment in a Coffee Shop}
\section{Micropayments for Internet Service}
\section{Routed Payments}

\end{document}
